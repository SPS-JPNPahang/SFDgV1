<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Ujian Diagnostik API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style> .loading-overlay { /* ... kod sama ... */ } </style>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow-sm mx-auto" style="max-width: 400px;">
            <div class="card-body p-5">
                <h2 class="text-center mb-4">Ujian API SFDg</h2>
                <form id="test-form">
                    <div class="mb-3">
                        <label for="test-email" class="form-label">E-mel Pengguna (dari Sheet)</label>
                        <input type="email" class="form-control" id="test-email" required value="shabiel11@gmail.com" />
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Hantar Ujian ke API</button>
                    <div id="test-result" class="mt-3"></div>
                </form>
            </div>
        </div>
    </div>

     <div id="loading-spinner" class="loading-overlay d-none">
        <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec"; // URL API ANDA
            const testForm = document.getElementById("test-form");
            const testResult = document.getElementById("test-result");
            const loadingSpinner = document.getElementById("loading-spinner");

            testForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const emailToTest = document.getElementById("test-email").value;
                testResult.innerHTML = '';
                loadingSpinner.classList.remove('d-none');

                console.log(`Menguji API dengan e-mel: ${emailToTest}`);

                try {
                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            // Kita hantar 'action' yang TIDAK DIKENALI oleh API ringkas ini,
                            // supaya ia tidak masuk ke logik token,
                            // tetapi kita hantar 'email' supaya ia boleh cuba cari.
                            action: "testUserData",
                            email: emailToTest
                        }),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }, // Cuba guna text/plain
                        mode: 'cors',
                        redirect: "follow"
                    });

                    console.log(`Status Jawapan API: ${response.status}`);

                    if (!response.ok) {
                        let errorText = response.statusText;
                        try { errorText = await response.text(); } catch(e) {}
                        throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                    }

                    const responseText = await response.text();
                     console.log(`Jawapan Teks API: ${responseText}`);
                    if (!responseText) {
                        throw new Error("API tidak memulangkan data.");
                    }
                    const result = JSON.parse(responseText);

                    if (result.status === "success") {
                        testResult.innerHTML = `<div class="alert alert-success">Berjaya! Nama: ${result.nama}, Peranan: ${result.peranan}</div>`;
                    } else {
                        testResult.innerHTML = `<div class="alert alert-danger">Gagal: ${result.message}</div>`;
                    }

                } catch (error) {
                    console.error("Ralat Ujian API:", error);
                    testResult.innerHTML = `<div class="alert alert-danger">Ralat Kritikal: ${error.message} (Sila semak Console)</div>`;
                } finally {
                    loadingSpinner.classList.add('d-none');
                }
            });
        });
    </script>
</body>
</html>
