<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital (Firebase)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f8f9fa; }
        .app-tab { border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .app-tab.active { font-weight: bold; color: #0d6efd !important; border-bottom-color: #0d6efd; background-color: #e9f2ff; }
        .app-tab:hover { background-color: #eef; }
        .app-tab-content { display: none; }
        .app-tab-content.active { display: block; }
        #pdf-render-container { overflow: auto; max-height: 60vh; text-align: center; background: #525659; }
        #pdf-canvas { border: 1px solid #ccc; cursor: crosshair; }
        #signature-pad-container { text-align: center; }
        #signature-canvas { background-color: #fff; cursor: crosshair; width: 400px; height: 200px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .list-group-item-action:hover { background-color: #f5f5f5; }
        .status-draf { border-left: 5px solid #ffc107; }
        .status-selesai { border-left: 5px solid #198754; }
    </style>
</head>
<body class="bg-light">

    <!-- 1. Halaman Log Masuk -->
    <div id="login-container" class="container">
        <div class="row min-vh-100 justify-content-center align-items-center">
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4">Log Masuk SFDg</h2>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="login-email" class="form-label">E-mel</label> <!-- Tukar kepada E-mel -->
                                <input type="email" class="form-control" id="login-email" required />
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Kata Laluan</label>
                                <input type="password" class="form-control" id="password" required />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Log Masuk</button>
                            <div id="login-error" class="text-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Aplikasi Utama (Tersembunyi) -->
    <div id="app-container" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">SFDg</a>
                <div class="d-flex align-items-center">
                     <span class="navbar-text me-3" id="user-greeting"></span>
                     <button class="btn btn-outline-light" id="logout-button"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </nav>
        <nav class="nav nav-pills flex-column flex-sm-row nav-fill mt-3 px-3" id="main-tabs">
            <a class="nav-link text-dark app-tab" href="#" id="tab-hantar" data-tab="hantar-surat-tab"><i class="bi bi-send-plus"></i> Hantar Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-data" data-tab="data-tab"><i class="bi bi-folder-check"></i> Data Surat Dihantar</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-tandatangan" data-tab="tandatangan-surat-tab"><i class="bi bi-pencil-square"></i> Tandatangan Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-admin" data-tab="admin-tab"><i class="bi bi-gear"></i> Admin</a>
        </nav>
        <main class="container-fluid mt-4">
            <div id="hantar-surat-tab" class="app-tab-content">
                <h3>Hantar Surat Baru</h3>
                <form id="hantar-surat-form" class="card p-4">
                     <div class="mb-3">
                        <label for="surat-tajuk" class="form-label">Tajuk Surat</label>
                        <input type="text" class="form-control" id="surat-tajuk" required />
                    </div>
                    <div class="mb-3">
                        <label for="surat-sektor" class="form-label">Sektor Penghantar</label>
                        <input type="text" class="form-control" id="surat-sektor" required placeholder="Cth: SPS, SPP"/>
                    </div>
                    <div class="mb-3">
                        <label for="surat-pelulus" class="form-label">Untuk Diluluskan Oleh (Penerima)</label>
                        <select class="form-select" id="surat-pelulus" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="surat-fail" class="form-label">Muat Naik Fail PDF</label>
                        <input type="file" class="form-control" id="surat-fail" accept="application/pdf" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Hantar</button>
                </form>
            </div>
            <div id="data-tab" class="app-tab-content">
                <h3>Status Surat Dihantar</h3>
                <div id="data-list" class="list-group"></div>
            </div>
            <div id="tandatangan-surat-tab" class="app-tab-content">
                <h3>Surat Untuk Ditandatangani</h3>
                <div id="tandatangan-list" class="list-group"></div>
            </div>
            <div id="admin-tab" class="app-tab-content">
                <h3>Panel Admin</h3>
                <p>Paparan untuk Admin akan dibina kemudian.</p>
                <div id="admin-list"></div>
            </div>
        </main>
    </div>

    <!-- 3. Modal Penanda Tangan -->
     <div class="modal fade" id="signer-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signer-title">Tandatangan Dokumen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="signer-body">
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <button class="btn btn-outline-secondary" id="prev-page"><i class="bi bi-arrow-left"></i></button>
                            <span class="ms-2 me-2">Muka Surat: <span id="page-num"></span> / <span id="page-count"></span></span>
                            <button class="btn btn-outline-secondary" id="next-page"><i class="bi bi-arrow-right"></i></button>
                        </div>
                        <div>
                            <button class="btn btn-success" id="place-signature-button"><i class="bi bi-pencil-fill"></i> Letak Tandatangan</button>
                            <button class="btn btn-info" id="clear-signature-button"><i class="bi bi-arrow-clockwise"></i> Lukis Semula</button>
                        </div>
                    </div>
                    <div id="signature-pad-container" class="mb-2 p-3 border rounded bg-light">
                        <h6 class="text-center">Sila lukis tandatangan anda di kotak bawah:</h6>
                        <canvas id="signature-canvas" class="border"></canvas>
                    </div>
                    <div id="pdf-render-container">
                        <canvas id="pdf-canvas" class="border w-100"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-signature-button">Simpan & Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Spinner/Loading Global -->
    <div id="loading-spinner" class="loading-overlay d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Pustaka (Libraries) Penting -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <!--
    ==================================================
    KOD FIREBASE DAN JAVASCRIPT APLIKASI
    ==================================================
    -->
    <!-- Firebase SDK (v9+ menggunakan sintaks modular) -->
    <script type="module">
        // Import fungsi yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        // ==================================================
        // KONFIGURASI FIREBASE ANDA
        // ==================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBxKAyqxJt-4u9MjXCdondOdu4l53WRYn4", // <-- Dari Firebase
          authDomain: "sfdg-app.firebaseapp.com",       // <-- Dari Firebase
          projectId: "sfdg-app",                   // <-- Dari Firebase
          storageBucket: "sfdg-app.appspot.com", // <-- Betulkan jika perlu
          messagingSenderId: "724667320333",       // <-- Dari Firebase
          appId: "1:724667320333:web:cd19e8d7b262eeb7d7ed44" // <-- Dari Firebase
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Dapatkan instance Authentication

        // ==================================================
        // KOD APLIKASI SFDg (JavaScript)
        // ==================================================
        document.addEventListener("DOMContentLoaded", () => {

            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec"; // URL API BARU Anda

            let userSession = { token: null, nama: null, peranan: null, email: null, firebaseToken: null }; // Tambah firebaseToken

            const signerState = { /* ... kod sama ... */ };
            const signerModal = new bootstrap.Modal(document.getElementById("signer-modal"));
            const loginContainer = document.getElementById("login-container");
            const appContainer = document.getElementById("app-container");
            const loadingSpinner = document.getElementById("loading-spinner");

            // ==================================================
            // PENGURUSAN UTAMA APLIKASI
            // ==================================================

            // Pendengar status pengesahan Firebase
            onAuthStateChanged(auth, async (user) => {
                showLoading(true);
                if (user) {
                    // Pengguna telah log masuk melalui Firebase
                    try {
                        const idToken = await user.getIdToken(); // Dapatkan ID Token
                        userSession.firebaseToken = idToken;
                        userSession.email = user.email; // Gunakan e-mel dari Firebase

                        // Panggil API untuk dapatkan Nama & Peranan dari Google Sheet
                        const appData = await apiCall("getUserData", { email: user.email }); // Fungsi API baru diperlukan
                        
                        userSession.nama = appData.nama;
                        userSession.peranan = appData.peranan;
                        sessionStorage.setItem("sfdg_session", JSON.stringify(userSession)); // Simpan data lengkap
                        showApp();
                    } catch (error) {
                        console.error("Gagal mendapatkan data pengguna dari API:", error);
                        handleLogout(); // Log keluar jika gagal dapatkan data
                    }

                } else {
                    // Pengguna telah log keluar atau belum log masuk
                    handleLogout(); // Pastikan sesi tempatan dibersihkan
                }
                showLoading(false);
            });

            function showLogin() {
                loginContainer.classList.remove("d-none");
                appContainer.classList.add("d-none");
            }

            function showApp() {
                loginContainer.classList.add("d-none");
                appContainer.classList.remove("d-none");
                document.getElementById("user-greeting").textContent = `Helo, ${userSession.nama}`;
                setupTabs();
                const firstVisibleTab = document.querySelector(".app-tab:not(.d-none)");
                if (firstVisibleTab) {
                    switchTab(firstVisibleTab.dataset.tab);
                }
            }

            function setupTabs() {
                const { peranan } = userSession;
                if (!peranan) return; // Jika peranan belum dimuatkan
                const isPelulus = (peranan !== "Staf" && peranan !== "Admin");
                const isStaf = (peranan === "Staf");
                const isAdmin = (peranan === "Admin");

                document.getElementById("tab-hantar").classList.toggle("d-none", !isStaf);
                document.getElementById("tab-data").classList.toggle("d-none", !isStaf);
                document.getElementById("tab-tandatangan").classList.toggle("d-none", !isPelulus);
                document.getElementById("tab-admin").classList.toggle("d-none", !isAdmin);
            }

            function switchTab(tabId) {
                document.querySelectorAll(".app-tab").forEach(tab => {
                    tab.classList.toggle("active", tab.dataset.tab === tabId);
                });
                document.querySelectorAll(".app-tab-content").forEach(content => {
                    content.classList.toggle("active", content.id === tabId);
                });

                switch (tabId) {
                    case "hantar-surat-tab": loadHantarSuratForm(); break;
                    case "data-tab": loadDataTab(); break;
                    case "tandatangan-surat-tab": loadSuratUntukDitandatangani(); break;
                    case "admin-tab": break;
                }
            }

            // --- Fungsi apiCall Diubahsuai (Menghantar Firebase ID Token) ---
            async function apiCall(action, payload = {}) {
                showLoading(true);
                // Dapatkan token Firebase terkini
                const currentUser = auth.currentUser;
                if (!currentUser && action !== 'getUserData') { // getUserData mungkin dipanggil sebelum auth state lengkap
                     handleLogout(); // Log keluar jika tiada pengguna Firebase
                     throw new Error("Pengguna tidak disahkan oleh Firebase.");
                }
                
                let idToken = userSession.firebaseToken; // Guna token dari sesi
                 // Dapatkan token baru jika perlu (jika hampir tamat tempoh - logik ini boleh ditambah)
                 if (currentUser) {
                     try {
                        idToken = await currentUser.getIdToken(true); // Paksa refresh token
                        userSession.firebaseToken = idToken; // Kemas kini sesi
                     } catch (tokenError) {
                         console.error("Gagal refresh Firebase token:", tokenError);
                         handleLogout();
                         throw new Error("Gagal mengesahkan sesi pengguna.");
                     }
                 }


                try {
                    const requestBody = { action: action, ...payload }; // Tidak perlu hantar token Apps Script lagi
                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        body: JSON.stringify(requestBody),
                        headers: {
                           "Content-Type": "application/json",
                           "Authorization": `Bearer ${idToken}` // Hantar Firebase ID Token
                        },
                        redirect: "follow"
                    });
                    if (!response.ok) {
                         let errorText = response.statusText;
                         try { errorText = await response.text(); } catch(e) {}
                         throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                    }
                    const responseText = await response.text();
                    if (!responseText) {
                        console.warn("API call returned empty response.");
                        showLoading(false);
                        return { status: "success", message: "Operasi mungkin berjaya (tiada data dikembalikan)." };
                    }
                    const result = JSON.parse(responseText);
                    if (result.status === "error") throw new Error(result.message);

                    showLoading(false);
                    return result;
                } catch (error) {
                    showLoading(false);
                    console.error(`API Call Error (${action}):`, error);
                    alert(`Ralat API: ${error.message}`);
                    if (error.message.includes("Sesi tidak sah") || error.message.includes("token")) {
                         handleLogout();
                    }
                    throw error;
                }
            }

            function showLoading(show) { /* ... kod sama ... */ }
            function fileToBase64(file) { /* ... kod sama ... */ }

            // ==================================================
            // LOGIK PENGESAHAN (Menggunakan Firebase Auth)
            // ==================================================

            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("login-email").value; // Guna ID login-email
                const password = document.getElementById("password").value;
                const errorEl = document.getElementById("login-error");
                errorEl.classList.add('d-none');

                showLoading(true);
                try {
                    // Cuba log masuk guna Firebase
                    await signInWithEmailAndPassword(auth, email, password);
                    // Jika berjaya, onAuthStateChanged akan mengendalikan selebihnya (dapatkan token, panggil API, showApp)
                } catch (error) {
                    // Tangkap ralat log masuk Firebase
                    console.error("Firebase Login Error:", error);
                    let message = "Log masuk gagal. Sila periksa e-mel dan kata laluan.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        message = "E-mel atau kata laluan tidak sah.";
                    } else if (error.code === 'auth/invalid-email') {
                         message = "Format e-mel tidak sah.";
                    }
                    errorEl.textContent = message;
                    errorEl.classList.remove("d-none");
                    showLoading(false); // Pastikan spinner disembunyikan jika gagal
                }
                // Tidak perlu 'finally' di sini kerana onAuthStateChanged akan uruskan spinner jika berjaya
            });

            // --- Fungsi Log Keluar Diubahsuai ---
            document.getElementById("logout-button").addEventListener("click", async () => {
                 showLoading(true);
                 try {
                     await signOut(auth); // Log keluar dari Firebase
                     // onAuthStateChanged akan mengesan perubahan ini dan memanggil handleLogout
                 } catch (error) {
                      console.error("Firebase Logout Error:", error);
                      alert("Gagal log keluar.");
                      showLoading(false);
                 }
            });

            // --- Fungsi handleLogout Diubahsuai (Dipanggil oleh onAuthStateChanged) ---
            function handleLogout() {
                sessionStorage.removeItem("sfdg_session");
                userSession = { token: null, nama: null, peranan: null, email: null, firebaseToken: null };
                showLogin(); // Terus tunjuk skrin log masuk
                showLoading(false); // Pastikan spinner disembunyikan
            }


            // ... (Semua kod lain untuk Tab 1, 2, 3 dan Modal Penanda Tangan kekal sama) ...
            
             // ==================================================
            // KOD YANG SAMA SEPERTI SEBELUM INI (SALIN SEMUA)
            // ==================================================
            
            // ... (Salin semua fungsi dari loadHantarSuratForm hingga event listener .app-tab) ...


            // Mulakan aplikasi (onAuthStateChanged akan dipanggil secara automatik)
            // checkSession(); // Tidak diperlukan lagi, Firebase uruskan
        });
    </script>
</body>
</html>
