<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital (Ringkas)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style> /* ... CSS sama seperti sebelum ini ... */ </style>
</head>
<body class="bg-light">

    <div id="login-container" class="container">
        <div class="row min-vh-100 justify-content-center align-items-center">
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4">Log Masuk SFDg</h2>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="login-id" class="form-label">ID Log Masuk</label> <input type="text" class="form-control" id="login-id" required />
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Kata Laluan</label>
                                <input type="password" class="form-control" id="password" required />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Log Masuk</button>
                            <div id="login-error" class="text-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="d-none">
        </div>

    <div class="modal fade" id="signer-modal" tabindex="-1" aria-hidden="true">
        </div>

    <div id="loading-spinner" class="loading-overlay d-none">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Ready - Versi Ringkas");

            // !!! PASTIKAN URL INI MASIH URL DEPLOYMENT TERKINI ANDA !!!
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec";
            let userSession = { nama: null, peranan: null, userId: null }; // Simpan userId (IDLogMasuk)

            // ... (Pembolehubah DOM dan Signer sama seperti sebelum ini) ...
            const signerState = { pdfDoc: null, currentPageNum: 1, pdfLibDoc: null, originalPdfBytes: null, signaturePad: null, signatureImage: null, currentSuratId: null, pdfCanvas: document.getElementById("pdf-canvas"), sigCanvas: document.getElementById("signature-canvas"), placement: null };
            const signerModal = new bootstrap.Modal(document.getElementById("signer-modal"));
            const loginContainer = document.getElementById("login-container");
            const appContainer = document.getElementById("app-container");
            const loadingSpinner = document.getElementById("loading-spinner");

            // --- PENGURUSAN UTAMA ---
            function checkSession() { // Semak sesi dari sessionStorage
                const session = JSON.parse(sessionStorage.getItem("sfdg_simple_session"));
                if (session && session.userId) {
                    userSession = session;
                    showApp();
                } else {
                    showLogin();
                }
            }
            function showLogin() { loginContainer.classList.remove("d-none"); appContainer.classList.add("d-none"); }
            function showApp() {
                 loginContainer.classList.add("d-none"); appContainer.classList.remove("d-none");
                 document.getElementById("user-greeting").textContent = `Helo, ${userSession.nama}`;
                 setupTabs();
                 const firstVisibleTab = document.querySelector(".app-tab:not(.d-none)");
                 if (firstVisibleTab) { switchTab(firstVisibleTab.dataset.tab); }
            }
            function setupTabs() { /* ... kod sama ... */ }
            function switchTab(tabId) { /* ... kod sama ... */ }
            function showLoading(show) { /* ... kod sama ... */ }
            function fileToBase64(file) { /* ... kod sama ... */ }

            // --- apiCall RINGKAS (text/plain, hantar userId) ---
            async function apiCall(action, payload = {}) {
                showLoading(true);
                try {
                    // Tambah userId ke payload jika pengguna log masuk
                    if (userSession.userId) {
                        payload.userId = userSession.userId;
                    }

                    const requestBody = { action: action, ...payload };
                    const headers = { "Content-Type": "text/plain;charset=utf-8" }; // Guna text/plain

                    console.log(`Calling API (${action}) with payload:`, requestBody);

                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        body: JSON.stringify(requestBody), // Hantar sebagai string
                        headers: headers,
                        mode: 'cors',
                        redirect: "follow"
                    });

                    console.log(`API Call (${action}) Status: ${response.status}`);
                    const responseText = await response.text();
                    console.log(`API Call (${action}) Response Text: ${responseText.substring(0, 150)}...`);

                    if (!response.ok) { throw new Error(`Ralat Rangkaian: ${response.status} ${responseText}`); }
                    if (!responseText) { throw new Error("API tidak memulangkan data."); }
                    const result = JSON.parse(responseText);
                    if (result.status === "error") throw new Error(result.message);

                    showLoading(false);
                    return result;
                } catch (error) {
                    showLoading(false);
                    console.error(`API Call Exception (${action}):`, error);
                    alert(`Ralat API (${action}): ${error.message}`);
                    // Mungkin log keluar jika ralat berkaitan sesi
                    if (error.message.includes("Sesi pengguna tidak sah")) { handleLogout(); }
                    throw error;
                }
            }


            // --- Log Masuk ASAS (Panggil API checkLogin) ---
            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const idLogMasuk = document.getElementById("login-id").value;
                const password = document.getElementById("password").value;
                const errorEl = document.getElementById("login-error");
                errorEl.classList.add('d-none');
                showLoading(true);

                try {
                    console.log(`Attempting login for ID: ${idLogMasuk}`);
                    // Guna apiCall untuk hantar permintaan login
                    const result = await apiCall("login", { idLogMasuk: idLogMasuk, password: password });

                    console.log("Login API response:", result);
                    if (result.status === "success") {
                        userSession = {
                            nama: result.nama,
                            peranan: result.peranan,
                            userId: result.userId // Simpan IDLogMasuk sebagai userId
                        };
                        sessionStorage.setItem("sfdg_simple_session", JSON.stringify(userSession));
                        showApp();
                    } else {
                         // Ralat sepatutnya sudah ditangkap oleh apiCall, tapi sebagai langkah keselamatan
                         throw new Error(result.message || "Log masuk gagal.");
                    }
                } catch (error) {
                    console.error("Login attempt failed:", error);
                    errorEl.textContent = error.message;
                    errorEl.classList.remove("d-none");
                } finally {
                    showLoading(false);
                }
            });

            // --- Log Keluar ASAS ---
             function handleLogout() {
                sessionStorage.removeItem("sfdg_simple_session");
                userSession = { nama: null, peranan: null, userId: null };
                showLogin();
                showLoading(false);
            }
            document.getElementById("logout-button").addEventListener("click", handleLogout);


            // ... (Salin semua kod fungsi lain dari Fasa 29 TANPA PERUBAHAN) ...
             async function loadHantarSuratForm() { /*...*/ }
             document.getElementById("hantar-surat-form").addEventListener("submit", async (e) => { /*...*/ });
             async function loadDataTab() { /*...*/ }
             async function loadSuratUntukDitandatangani() { /*...*/ }
             async function bukaPenandaTangan(suratId, fileId) { /*...*/ }
             async function renderPDFPage(num) { /*...*/ }
             document.getElementById("prev-page").addEventListener("click", () => { /*...*/ });
             document.getElementById("next-page").addEventListener("click", () => { /*...*/ });
             document.getElementById("clear-signature-button").addEventListener("click", () => { /*...*/ });
             document.getElementById("place-signature-button").addEventListener("click", () => { /*...*/ });
             signerState.pdfCanvas.addEventListener("click", async (e) => { /*...*/ });
             document.getElementById("save-signature-button").addEventListener("click", async () => { /*...*/ });
             document.querySelectorAll(".app-tab").forEach(tab => { /*...*/ });

            // Mulakan aplikasi dengan menyemak sesi
            checkSession();
        });
    </script>
</body>
</html>
