<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital (doGet/doPost)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style> /* ... CSS sama ... */ </style>
</head>
<body class="bg-light">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Ready - Versi doGet/doPost");

            // !!! PASTIKAN URL INI MASIH URL DEPLOYMENT TERKINI ANDA !!!
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec";
            let userSession = { nama: null, peranan: null, userId: null };

            // ... (Pembolehubah DOM dan Signer sama) ...

            // --- PENGURUSAN UTAMA ---
            function checkSession() { /* ... kod sama ... */ }
            function showLogin() { /* ... kod sama ... */ }
            function showApp() { /* ... kod sama ... */ }
            function setupTabs() { /* ... kod sama ... */ }
            function switchTab(tabId) { /* ... kod sama ... */ }
            function showLoading(show) { /* ... kod sama ... */ }
            function fileToBase64(file) { /* ... kod sama ... */ }

            // --- apiCall doGet/doPost ---
            async function apiCall(action, payload = {}, method = 'POST') {
                showLoading(true);
                let url = GAS_API_URL;
                let options = {
                    method: method,
                    mode: 'cors',
                    redirect: 'follow',
                    headers: {} // Header kosong secara lalai
                };

                // Tambah userId ke payload jika ada sesi
                if (userSession.userId) {
                    payload.userId = userSession.userId;
                }

                if (method === 'GET') {
                    // Bina query string untuk GET
                    const params = new URLSearchParams({ action, ...payload });
                    url += `?${params.toString()}`;
                    console.log(`Calling API (GET): ${url}`);
                } else { // POST
                    // Gunakan FormData untuk POST bagi mengelak preflight
                    const formData = new FormData();
                    formData.append('action', action);
                    for (const key in payload) {
                        formData.append(key, payload[key]);
                    }
                    options.body = formData;
                    // JANGAN set Content-Type, biar browser lakukannya untuk FormData
                    console.log(`Calling API (POST) for action: ${action}`);
                }

                try {
                    const response = await fetch(url, options);
                    console.log(`API Call (${action}) Status: ${response.status}`);
                    const responseText = await response.text();
                    console.log(`API Call (${action}) Response Text: ${responseText.substring(0, 150)}...`);

                    if (!response.ok) { throw new Error(`Ralat Rangkaian: ${response.status} ${responseText}`); }
                    if (!responseText) { throw new Error("API tidak memulangkan data."); }
                    const result = JSON.parse(responseText);
                    if (result.status === "error") throw new Error(result.message);

                    showLoading(false);
                    return result.data; // Kembalikan 'data' dari respons API

                } catch (error) {
                    showLoading(false);
                    console.error(`API Call Exception (${action}):`, error);
                    alert(`Ralat API (${action}): ${error.message}`);
                    if (error.message.includes("Sesi pengguna tidak sah")) { handleLogout(); }
                    throw error;
                }
            }


            // --- Log Masuk (Guna POST dengan FormData) ---
            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const idLogMasuk = document.getElementById("login-id").value;
                const password = document.getElementById("password").value;
                const errorEl = document.getElementById("login-error");
                errorEl.classList.add('d-none');
                showLoading(true);

                try {
                    console.log(`Attempting login for ID: ${idLogMasuk}`);
                    // Guna apiCall (POST)
                    const resultData = await apiCall("login", { idLogMasuk: idLogMasuk, password: password }, 'POST');

                    console.log("Login API response data:", resultData);
                    // API kini mengembalikan data terus di bawah 'data'
                    userSession = {
                        nama: resultData.nama,
                        peranan: resultData.peranan,
                        userId: resultData.userId
                    };
                    sessionStorage.setItem("sfdg_simple_session", JSON.stringify(userSession));
                    showApp();

                } catch (error) {
                    console.error("Login attempt failed:", error);
                    errorEl.textContent = error.message;
                    errorEl.classList.remove("d-none");
                } finally {
                    showLoading(false);
                }
            });

            // --- Log Keluar ASAS ---
             function handleLogout() { /* ... kod sama ... */ }
             document.getElementById("logout-button").addEventListener("click", handleLogout);

            // --- Fungsi Muat Data (Guna GET) ---
             async function loadHantarSuratForm() {
                try {
                    const pelulus = await apiCall("getSenaraiPelulus", {}, 'GET'); // GET
                    const selectPelulus = document.getElementById("surat-pelulus");
                    selectPelulus.innerHTML = '<option value="">-- Pilih Penerima --</option>';
                    pelulus.forEach(p => { selectPelulus.add(new Option(p.nama, p.id)); });
                } catch (error) { console.error("Gagal load pelulus:", error); }
            }

            async function loadDataTab() {
                const listEl = document.getElementById("data-list");
                listEl.innerHTML = '<div class="text-center">Memuatkan...</div>';
                try {
                    const suratList = await apiCall("getSuratDihantar", {}, 'GET'); // GET
                    // ... (Kod paparkan jadual sama seperti sebelum ini) ...
                } catch (error) { listEl.innerHTML = `<div class="alert alert-danger">Gagal muat data: ${error.message}</div>`; }
            }

            async function loadSuratUntukDitandatangani() {
                const listEl = document.getElementById("tandatangan-list");
                listEl.innerHTML = '<div class="text-center">Memuatkan...</div>';
                try {
                    const suratList = await apiCall("getSuratUntukDitandatangani", {}, 'GET'); // GET
                     // ... (Kod paparkan jadual sama seperti sebelum ini, panggil bukaPenandaTangan) ...
                } catch (error) { listEl.innerHTML = `<div class="alert alert-danger">Gagal muat surat: ${error.message}</div>`; }
            }

            // --- Fungsi Tindakan (Guna POST) ---
            document.getElementById("hantar-surat-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const tajuk = document.getElementById("surat-tajuk").value;
                const sektor = document.getElementById("surat-sektor").value;
                const idPelulus = document.getElementById("surat-pelulus").value;
                const fileInput = document.getElementById("surat-fail");
                if (!fileInput.files[0]) return alert("Pilih fail PDF.");
                try {
                    const fileBase64 = await fileToBase64(fileInput.files[0]);
                    await apiCall("uploadDrafSurat", { // POST (lalai)
                        fileBase64: fileBase64.split(',')[1], // Hantar base64 sahaja
                        fileName: fileInput.files[0].name,
                        tajuk: tajuk, sektor: sektor, idPelulus: idPelulus
                    });
                    alert("Surat berjaya dihantar!"); e.target.reset(); loadDataTab(); switchTab('data-tab');
                } catch (error) { alert(`Gagal hantar: ${error.message}`); }
            });

             async function bukaPenandaTangan(suratId, fileId, tajuk) { // Terima tajuk juga
                signerState.currentSuratId = suratId;
                // ... (Reset state lain) ...
                 document.getElementById('sign-surat-title').textContent = tajuk; // Papar tajuk
                 signerModal.show();
                 try {
                     const pdfDataResult = await apiCall("getPDFData", { fileId: fileId }, 'GET'); // GET
                     const pdfData = atob(pdfDataResult.pdfData);
                     // ... (Kod muat PDF ke PDF.js sama) ...
                 } catch (error) { alert(`Gagal muat PDF: ${error.message}`); signerModal.hide(); }
            }

             document.getElementById("save-signature-button").addEventListener("click", async () => {
                if (!signerState.placement) return alert("Letak tandatangan dahulu.");
                if (!confirm('Anda pasti?')) return;
                try {
                    // ... (Kod jana PDF baru sama seperti sebelum ini) ...
                    const pdfBytes = await pdfLibDoc.save();
                    let binary = ''; const len = pdfBytes.byteLength;
                    for (let i = 0; i < len; i++) { binary += String.fromCharCode(pdfBytes[i]); }
                    const signedPdfBase64 = btoa(binary);

                    await apiCall("saveSignedPDF", { // POST (lalai)
                        signedPdfBase64: signedPdfBase64,
                        suratId: signerState.currentSuratId
                    });
                    alert("Tandatangan berjaya disimpan!"); signerModal.hide(); loadSuratUntukDitandatangani();
                } catch (error) { alert(`Gagal simpan: ${error.message}`); }
            });


            // ... (Salin semua kod fungsi lain yang tidak berubah) ...
             // (showLogin, showApp, setupTabs, switchTab, showLoading, fileToBase64, handleLogout)
             // (loadHantarSuratForm, loadDataTab, loadSuratUntukDitandatangani)
             // (renderPDFPage, butang nav PDF, butang sig pad, event listener sigCanvas)


            // Mulakan aplikasi
            checkSession();
        });
    </script>
</body>
</html>
