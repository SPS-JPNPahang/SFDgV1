<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital (Firebase)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f8f9fa; }
        .app-tab { border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .app-tab.active { font-weight: bold; color: #0d6efd !important; border-bottom-color: #0d6efd; background-color: #e9f2ff; }
        .app-tab:hover { background-color: #eef; }
        .app-tab-content { display: none; }
        .app-tab-content.active { display: block; }
        #pdf-render-container { overflow: auto; max-height: 60vh; text-align: center; background: #525659; }
        #pdf-canvas { border: 1px solid #ccc; cursor: crosshair; }
        #signature-pad-container { text-align: center; }
        #signature-canvas { background-color: #fff; cursor: crosshair; width: 400px; height: 200px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .list-group-item-action:hover { background-color: #f5f5f5; }
        .status-draf { border-left: 5px solid #ffc107; }
        .status-selesai { border-left: 5px solid #198754; }
    </style>
</head>
<body class="bg-light">

    <div id="login-container" class="container">
        <div class="row min-vh-100 justify-content-center align-items-center">
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4">Log Masuk SFDg</h2>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="login-email" class="form-label">E-mel</label>
                                <input type="email" class="form-control" id="login-email" required />
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Kata Laluan</label>
                                <input type="password" class="form-control" id="password" required />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Log Masuk</button>
                            <div id="login-error" class="text-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">SFDg</a>
                <div class="d-flex align-items-center">
                     <span class="navbar-text me-3" id="user-greeting"></span>
                     <button class="btn btn-outline-light" id="logout-button"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </nav>
        <nav class="nav nav-pills flex-column flex-sm-row nav-fill mt-3 px-3" id="main-tabs">
            <a class="nav-link text-dark app-tab" href="#" id="tab-hantar" data-tab="hantar-surat-tab"><i class="bi bi-send-plus"></i> Hantar Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-data" data-tab="data-tab"><i class="bi bi-folder-check"></i> Data Surat Dihantar</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-tandatangan" data-tab="tandatangan-surat-tab"><i class="bi bi-pencil-square"></i> Tandatangan Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-admin" data-tab="admin-tab"><i class="bi bi-gear"></i> Admin</a>
        </nav>
        <main class="container-fluid mt-4">
            <div id="hantar-surat-tab" class="app-tab-content">
                <h3>Hantar Surat Baru</h3>
                <form id="hantar-surat-form" class="card p-4">
                     <div class="mb-3">
                        <label for="surat-tajuk" class="form-label">Tajuk Surat</label>
                        <input type="text" class="form-control" id="surat-tajuk" required />
                    </div>
                    <div class="mb-3">
                        <label for="surat-sektor" class="form-label">Sektor Penghantar</label>
                        <input type="text" class="form-control" id="surat-sektor" required placeholder="Cth: SPS, SPP"/>
                    </div>
                    <div class="mb-3">
                        <label for="surat-pelulus" class="form-label">Untuk Diluluskan Oleh (Penerima)</label>
                        <select class="form-select" id="surat-pelulus" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="surat-fail" class="form-label">Muat Naik Fail PDF</label>
                        <input type="file" class="form-control" id="surat-fail" accept="application/pdf" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Hantar</button>
                </form>
            </div>
            <div id="data-tab" class="app-tab-content">
                <h3>Status Surat Dihantar</h3>
                <div id="data-list" class="list-group"></div>
            </div>
            <div id="tandatangan-surat-tab" class="app-tab-content">
                <h3>Surat Untuk Ditandatangani</h3>
                <div id="tandatangan-list" class="list-group"></div>
            </div>
            <div id="admin-tab" class="app-tab-content">
                <h3>Panel Admin</h3>
                <p>Paparan untuk Admin akan dibina kemudian.</p>
                <div id="admin-list"></div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="signer-modal" tabindex="-1" aria-hidden="true">
        </div>

    <div id="loading-spinner" class="loading-overlay d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <script type="module">
        // Import fungsi yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        console.log("Firebase Module Script Loaded - Fasa 23"); // <-- LOG ASAS 1

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
          apiKey: "AIzaSyBxKAyqxJt-4u9MjXCdondOdu4l53WRYn4",
          authDomain: "sfdg-app.firebaseapp.com",
          projectId: "sfdg-app",
          storageBucket: "sfdg-app.appspot.com",
          messagingSenderId: "724667320333",
          appId: "1:724667320333:web:cd19e8d7b262eeb7d7ed44"
        };

        // Inisialisasi Firebase
        let app;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            console.log("Firebase Initialized Successfully - Fasa 23"); // <-- LOG ASAS 2
        } catch (error) {
            console.error("Firebase Initialization Failed:", error); // <-- LOG Ralat Firebase Init
            alert("Ralat kritikal semasa memulakan Firebase. Sila semak Console.");
        }


        // Hanya jalankan kod aplikasi jika Firebase berjaya dimulakan
        if (app && auth) {
            document.addEventListener("DOMContentLoaded", () => {
                console.log("DOMContentLoaded event fired - Fasa 23"); // <-- LOG ASAS 3

                const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec";
                let userSession = { token: null, nama: null, peranan: null, email: null, firebaseToken: null };
                const signerState = { pdfDoc: null, currentPageNum: 1, pdfLibDoc: null, originalPdfBytes: null, signaturePad: null, signatureImage: null, currentSuratId: null, pdfCanvas: document.getElementById("pdf-canvas"), sigCanvas: document.getElementById("signature-canvas"), placement: null };
                const signerModal = new bootstrap.Modal(document.getElementById("signer-modal"));
                const loginContainer = document.getElementById("login-container");
                const appContainer = document.getElementById("app-container");
                const loadingSpinner = document.getElementById("loading-spinner");

                // --- onAuthStateChanged DENGAN LOG ---
                onAuthStateChanged(auth, async (user) => {
                    console.log("onAuthStateChanged triggered. User:", user ? user.email : 'null'); // <-- LOG 1
                    showLoading(true);
                    if (user) {
                        console.log("Firebase user detected:", user.email); // <-- LOG 2
                        try {
                            console.log("Getting Firebase ID Token..."); // <-- LOG 3
                            const idToken = await getIdToken(user, true); // Dapatkan/Refresh ID Token
                            console.log("Firebase ID Token obtained."); // <-- LOG 4
                            userSession.firebaseToken = idToken;
                            userSession.email = user.email;

                            console.log("Calling API action: getUserData for email:", user.email); // <-- LOG 5
                            const appData = await apiCall("getUserData", { email: user.email }); // Hantar e-mel dalam body juga
                            console.log("API response received for getUserData:", appData); // <-- LOG 6

                            if (appData.status === "success") {
                                userSession.nama = appData.nama;
                                userSession.peranan = appData.peranan;
                                sessionStorage.setItem("sfdg_session", JSON.stringify(userSession));
                                console.log("User session updated:", userSession); // <-- LOG 7
                                showApp();
                            } else {
                                throw new Error(appData.message || "Gagal mendapatkan data pengguna dari API.");
                            }
                        } catch (error) {
                            console.error("Auth State/API Error inside onAuthStateChanged:", error); // <-- LOG Ralat 1
                            alert(`Ralat pengesahan atau data pengguna: ${error.message}`);
                            handleLogout(); // Log keluar jika gagal
                        }
                    } else {
                        console.log("No Firebase user detected, calling handleLogout."); // <-- LOG 8
                        handleLogout();
                    }
                    showLoading(false);
                });

                // --- Fungsi log masuk DENGAN LOG ---
                 try {
                     const loginForm = document.getElementById("login-form");
                     if (loginForm) {
                         console.log("Attaching submit listener to login-form - Fasa 23"); // <-- LOG ASAS 4
                         loginForm.addEventListener("submit", async (e) => {
                             console.log("Login form submitted - Fasa 23"); // <-- LOG ASAS 5
                             e.preventDefault();
                             const email = document.getElementById("login-email").value;
                             const password = document.getElementById("password").value;
                             const errorEl = document.getElementById("login-error");
                             errorEl.classList.add('d-none');

                             showLoading(true);
                             try {
                                 console.log("Calling Firebase signInWithEmailAndPassword... - Fasa 23"); // <-- LOG ASAS 6
                                 await signInWithEmailAndPassword(auth, email, password);
                                 console.log("Firebase signIn successful (waiting for onAuthStateChanged) - Fasa 23"); // <-- LOG ASAS 7
                                 // Jika berjaya, onAuthStateChanged akan mengendalikan selebihnya
                             } catch (error) {
                                  console.error("Firebase Login Error in listener:", error); // <-- LOG Ralat Firebase Log Masuk
                                  let message = "Log masuk gagal.";
                                  if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                                      message = "E-mel atau kata laluan tidak sah.";
                                  } else if (error.code === 'auth/invalid-email') {
                                       message = "Format e-mel tidak sah.";
                                  } else {
                                       message = `Ralat log masuk: ${error.message}`; // Paparkan mesej Firebase sebenar
                                  }
                                  errorEl.textContent = message;
                                  errorEl.classList.remove("d-none");
                                  showLoading(false); // Pastikan spinner disembunyikan jika gagal
                             }
                              // Tidak perlu finally, onAuthStateChanged uruskan spinner jika berjaya
                         });
                         console.log("Submit listener attached successfully - Fasa 23"); // <-- LOG ASAS 8
                     } else {
                          console.error("Login form with id 'login-form' not found! - Fasa 23"); // <-- LOG Ralat Borang Tidak Dijumpai
                     }
                 } catch (listenerError) {
                      console.error("Error attaching login listener:", listenerError); // <-- LOG Ralat Listener
                 }


                // ... (Salin semua kod fungsi lain dari Fasa 21 TANPA PERUBAHAN) ...
                function showLogin() { /* ... */ }
                function showApp() { /* ... */ }
                function setupTabs() { /* ... */ }
                function switchTab(tabId) { /* ... */ }
                async function apiCall(action, payload = {}) { /* ... */ }
                function showLoading(show) { /* ... */ }
                function fileToBase64(file) { /* ... */ }
                function handleLogout() { /* ... */ }
                async function loadHantarSuratForm() { /* ... */ }
                document.getElementById("hantar-surat-form").addEventListener("submit", async (e) => { /* ... */ });
                async function loadDataTab() { /* ... */ }
                async function loadSuratUntukDitandatangani() { /* ... */ }
                async function bukaPenandaTangan(suratId, fileId) { /* ... */ }
                async function renderPDFPage(num) { /* ... */ }
                document.getElementById("prev-page").addEventListener("click", () => { /* ... */ });
                document.getElementById("next-page").addEventListener("click", () => { /* ... */ });
                document.getElementById("clear-signature-button").addEventListener("click", () => { /* ... */ });
                document.getElementById("place-signature-button").addEventListener("click", () => { /* ... */ });
                signerState.pdfCanvas.addEventListener("click", async (e) => { /* ... */ });
                document.getElementById("save-signature-button").addEventListener("click", async () => { /* ... */ });
                document.querySelectorAll(".app-tab").forEach(tab => { /* ... */ });
                document.getElementById("logout-button").addEventListener("click", async () => { /* ... */ });

                // Mulakan aplikasi (onAuthStateChanged akan dipanggil secara automatik)
                 console.log("Initial auth state check starting..."); // Log tambahan

            }); // Akhir DOMContentLoaded
        } // Akhir if (app && auth)

    </script>
</body>
</html>
