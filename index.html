<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFDg JPNP</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- 3. PDF.js (untuk memaparkan PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js"></script>
    <!-- 4. pdf-lib.js (untuk menulis/menandatangani PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    
    <style>
        /* Sembunyikan tab secara lalai */
        .page-content {
            display: none;
        }
        /* Tunjukkan tab yang aktif */
        .page-content.active {
            display: block;
        }
        /* Gaya untuk memaparkan PDF */
        #pdf-viewer {
            width: 100%;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            position: relative;
        }
        /* Kanvas untuk melukis tandatangan */
        #signature-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        /* Pastikan kanvas PDF di belakang kanvas tandatangan */
        #pdf-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Kontena Utama -->
    <div class="flex h-screen bg-gray-200">

        <!-- Sidebar (Bar Sisi) -->
        <div class="w-64 bg-gray-800 text-white flex flex-col fixed h-full z-10">
            <div class="px-6 py-4 border-b border-gray-700">
                <h1 class="text-2xl font-bold">SFDg JPNP</h1>
            </div>
            <nav class="flex-grow p-4">
                <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700" data-page="senarai-surat">
                    <i class="fas fa-list-ul w-6 text-center"></i>
                    <span class="ml-3">Senarai Surat</span>
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700" data-page="hantar-surat" id="nav-hantar-surat">
                    <i class="fas fa-paper-plane w-6 text-center"></i>
                    <span class="ml-3">Hantar Surat Baru</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button id="logout-button" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-sign-out-alt w-5 text-center"></i>
                    <span class="ml-2">Tukar Pengguna</span>
                </button>
            </div>
        </div>

        <!-- Kawasan Kandungan Utama -->
        <main class="flex-1 ml-64 p-8 overflow-y-auto">
            
            <!-- 1. Halaman Senarai Surat -->
            <div id="senarai-surat" class="page-content active">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6" id="senarai-title">Senarai Surat</h2>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarikh</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tajuk Surat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="kolum-staf">Staf</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="kolum-signatory">Untuk Perhatian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="letter-table-body">
                            <!-- Baris akan dijana oleh JavaScript -->
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Memuatkan data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Halaman Hantar Surat Baru -->
            <div id="hantar-surat" class="page-content">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Hantar Draf Surat Baru</h2>
                <div class="bg-white shadow-md rounded-lg p-8 max-w-2xl mx-auto">
                    <form id="upload-form">
                        <div class="mb-6">
                            <label for="tajuk" class="block text-sm font-medium text-gray-700 mb-2">Tajuk Surat</label>
                            <input type="text" id="tajuk" name="tajuk" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="signatoryList" class="block text-sm font-medium text-gray-700 mb-2">Pilih Pengarah / TP (Untuk Tandatangan)</label>
                            <select id="signatoryList" name="signatory" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="" disabled selected>Memuatkan senarai...</option>
                                <!-- Pilihan dijana oleh JavaScript -->
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="pdf-file" class="block text-sm font-medium text-gray-700 mb-2">Muat Naik Draf PDF</label>
                            <input type="file" id="pdf-file" name="pdf-file" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-lg file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100" accept="application/pdf" required>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out">
                                <i class="fas fa-paper-plane mr-2"></i>Hantar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal: Pemilihan Peranan (Login) -->
    <div id="roleModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Selamat Datang ke SFDg</h2>
            <p class="text-gray-600 mb-6">Sila pilih peranan dan nama anda untuk meneruskan.</p>
            <form id="role-form">
                <div class="mb-4">
                    <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Nama Anda</label>
                    <select id="userSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Memuatkan senarai...</option>
                        <!-- Pilihan dijana oleh JavaScript -->
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Tandatangan PDF -->
    <div id="signModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-800" id="signModalTitle">Tandatangan Surat</h2>
            <p class="text-sm text-gray-600 mb-4">Guna tetikus atau skrin sentuh untuk melukis tandatangan anda pada kanvas di bawah. Klik "Simpan" untuk memuktamadkan.</p>
            
            <!-- Kontena Paparan PDF & Tandatangan -->
            <div id="pdf-viewer" class="mb-4 relative">
                <!-- Kanvas untuk PDF -->
                <canvas id="pdf-canvas"></canvas>
                <!-- Kanvas untuk melukis tandatangan -->
                <canvas id="signature-canvas"></canvas>
            </div>
            
            <div class="flex justify-between items-center">
                <button id="clear-signature" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-eraser mr-2"></i>Padam
                </button>
                <div>
                    <button id="cancel-sign" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2">
                        Batal
                    </button>
                    <button id="save-signature" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Simpan Tandatangan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Memuatkan... -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[99] hidden">
        <div class="bg-white py-6 px-10 rounded-lg shadow-xl flex items-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <span class="text-xl font-medium text-gray-700 ml-4" id="loadingText">Memuatkan...</span>
        </div>
    </div>

    <!-- Toast Notifikasi (Kejayaan/Ralat) -->
    <div id="toast" class="fixed bottom-10 right-10 bg-green-600 text-white py-3 px-6 rounded-lg shadow-xl z-[100] hidden transition-all duration-300 ease-in-out">
        <p id="toast-message">Operasi berjaya!</p>
    </div>


    <!-- ============================================= -->
    <!-- SCRIPT UTAMA APLIKASI                       -->
    <!-- ============================================= -->
    <script>
        // --- KONFIGURASI PENTING ---
        // GANTIKAN DENGAN URL WEB APP ANDA YANG BARU (DARI AKAUN PERIBADI SETELAH DEPLOY BARU)
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw9roHPNxjgWoxvYVUUvbdTQdvPmAemVB5QnHy-fmj4MMp2H8G6O8Z7B01smywWG8ooMQ/exec"; // <-- GANTI INI

        // Pembolehubah Global
        let currentUser = null; // { Nama: "Ali (Staf)", Jawatan: "Staf" }
        let allUsersList = []; // Senarai penuh pengguna dari 'getUsers'
        let currentSignPdfData = {}; // Data untuk modal tandatangan

        // Rujukan Elemen DOM
        const pages = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const roleModal = document.getElementById('roleModal');
        const signModal = document.getElementById('signModal');
        const loadingModal = document.getElementById('loadingModal');
        const loadingText = document.getElementById('loadingText');

        // Rujukan PDF.js dan pdf-lib
        const { pdfjsLib } = window;
        const { PDFDocument } = window.PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // --- PENGURUSAN HALAMAN DAN MODAL ---

        // Tunjukkan halaman yang dipilih
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Kemas kini pautan nav yang aktif
            navLinks.forEach(link => {
                link.classList.remove('bg-gray-700', 'font-semibold');
                if (link.dataset.page === pageId) {
                    link.classList.add('bg-gray-700', 'font-semibold');
                }
            });

            // Muat semula data surat apabila kembali ke halaman senarai
            if (pageId === 'senarai-surat' && currentUser) {
                loadLetters();
            }
        }

        // Tunjukkan modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // Tutup modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Tunjukkan toast notifikasi
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.innerText = message;
            toast.className = 'fixed bottom-10 right-10 text-white py-3 px-6 rounded-lg shadow-xl z-[100] transition-all duration-300 ease-in-out'; // Reset
            
            if (isError) {
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.add('bg-green-600');
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // --- FUNGSI API (Google Apps Script) ---

        /**
         * Fungsi utama untuk berkomunikasi dengan Google Apps Script.
         * @param {string} action - Tindakan yang perlu dipanggil (cth: 'getUsers').
         * @param {object} [payload] - Data untuk dihantar (untuk POST).
         * @param {string} [method='GET'] - Kaedah HTTP (GET atau POST).
         */
        async function fetchFromGas(action, payload = {}, method = 'GET') {
            let url = `${GAS_URL}?action=${action}`;
            const options = {
                method: method,
                headers: {},
            };

            if (method === 'GET') {
                // Untuk GET, tambah parameter pada URL (jika ada)
                const params = new URLSearchParams();
                for (const key in payload) {
                    params.append(key, payload[key]);
                }
                if (params.toString()) {
                    url += `&${params.toString()}`;
                }
            } else if (method === 'POST') {
                // Untuk POST, hantar data sebagai JSON
                options.body = JSON.stringify({ action, ...payload });
                options.headers['Content-Type'] = 'application/json';
            }

            try {
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    // Cuba dapatkan teks ralat jika ada
                    let errorText = response.statusText;
                    try {
                        const errorBody = await response.text();
                        // Google Apps Script kadangkala membalas HTML untuk redirect atau ralat auth
                        if (errorBody.includes('<title>Sign in</title>')) {
                             errorText = "Redirected to login (check permissions/ownership)";
                        } else {
                             errorText += `: ${errorBody.substring(0, 100)}`; // Tunjuk permulaan ralat
                        }
                    } catch (e) { /* Abaikan jika teks tidak boleh dibaca */ }
                    throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success === false) {
                    throw new Error(result.message || 'Ralat tidak diketahui dari pelayan');
                }
                
                return result; // Sepatutnya mengandungi { success: true, ...data }

            } catch (error) {
                console.error('Ralat fetchFromGas:', error);
                showToast(`[RALAT] Gagal menghubungi pelayan: ${error.message}`, true); // Mesej lebih jelas
                throw error; // Lempar semula ralat untuk ditangkap oleh pemanggil
            }
        }

        // --- LOGIK UTAMA APLIKASI ---

        // 1. Muatkan senarai pengguna untuk modal login
        async function loadUsersForLogin() {
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="" disabled selected>Memuatkan pengguna...</option>'; // Status memuatkan
            try {
                const data = await fetchFromGas('getUsers');
                allUsersList = data.users; // Simpan senarai penuh
                
                userSelect.innerHTML = '<option value="" disabled selected>Pilih nama anda...</option>'; // Reset
                allUsersList.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.Nama;
                    option.textContent = `${user.Nama} (${user.Jawatan})`;
                    option.dataset.jawatan = user.Jawatan;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                userSelect.innerHTML = '<option value="" disabled selected>Ralat memuatkan pengguna</option>';
                console.error('Gagal memuatkan pengguna:', error);
                // Toast sudah dipaparkan oleh fetchFromGas
            }
        }

        // 2. Muatkan senarai pelulus (Signatory) untuk borang hantar surat
        async function loadSignatoriesForForm() {
            const signatoryList = document.getElementById('signatoryList');
             signatoryList.innerHTML = '<option value="" disabled selected>Memuatkan pelulus...</option>'; // Status memuatkan
            try {
                // Panggil 'getSenaraiPelulus' yang baru
                const data = await fetchFromGas('getSenaraiPelulus');
                
                signatoryList.innerHTML = '<option value="" disabled selected>Pilih Pengarah / TP...</option>'; // Reset
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.Nama;
                    option.textContent = `${user.Nama} (${user.Jawatan})`;
                    signatoryList.appendChild(option);
                });
            } catch (error) {
                signatoryList.innerHTML = '<option value="" disabled selected>Ralat memuatkan pelulus</option>';
                console.error('Gagal memuatkan pelulus:', error);
                 // Toast sudah dipaparkan oleh fetchFromGas
            }
        }
        
        // 3. Kendalikan pemilihan peranan (login)
        document.getElementById('role-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const userSelect = document.getElementById('userSelect');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                showToast('Sila pilih nama anda.', true);
                return;
            }

            currentUser = {
                Nama: selectedOption.value,
                Jawatan: selectedOption.dataset.jawatan
            };

            // Simpan ke localStorage untuk sesi
            localStorage.setItem('sfdgUser', JSON.stringify(currentUser));
            
            // Konfigurasi UI berdasarkan peranan
            setupUIPerRole(currentUser.Jawatan);
            
            closeModal('roleModal');
            showPage('senarai-surat'); // Tunjukkan senarai surat secara lalai
        });

        // 4. Konfigurasi UI berdasarkan peranan
        function setupUIPerRole(role) {
            if (!role) return;

            const roleLower = role.toLowerCase();
            
            if (roleLower === 'staf') {
                document.getElementById('nav-hantar-surat').style.display = 'block';
                document.getElementById('senarai-title').textContent = 'Surat Yang Telah Dihantar';
                document.getElementById('kolum-staf').style.display = 'none';
                document.getElementById('kolum-signatory').style.display = 'table-cell';
            } else if (roleLower === 'pengarah' || roleLower === 'tp') {
                document.getElementById('nav-hantar-surat').style.display = 'none';
                document.getElementById('senarai-title').textContent = 'Surat Untuk Ditandatangani';
                document.getElementById('kolum-staf').style.display = 'table-cell';
                document.getElementById('kolum-signatory').style.display = 'none';
            }
        }

        // 5. Muatkan senarai surat (Senarai Utama)
        async function loadLetters() {
            if (!currentUser) return;
            
            const tableBody = document.getElementById('letter-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Memuatkan data surat...</td></tr>';
            
            try {
                const data = await fetchFromGas('getLetters', { 
                    name: currentUser.Nama, 
                    role: currentUser.Jawatan 
                });

                if (!data.letters || data.letters.length === 0) { // Pemeriksaan tambahan
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tiada surat ditemui.</td></tr>';
                    return;
                }

                tableBody.innerHTML = ''; // Kosongkan jadual
                data.letters.forEach(letter => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    
                    const statusClass = letter.Status === 'Draf' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                    const isStaf = currentUser.Jawatan.toLowerCase() === 'staf';
                    
                    // Logik Butang Tindakan
                    let actionButton = '';
                    if (isStaf) {
                        if (letter.Status === 'Draf' && letter.DraftFileUrl) { // Pastikan URL ada
                            actionButton = `<a href="${letter.DraftFileUrl}" target="_blank" class="text-gray-500 hover:text-gray-700" title="Lihat Draf"><i class="fas fa-eye"></i></a>`;
                        } else if (letter.Status !== 'Draf' && letter.SignedFileUrl) { // Pastikan URL ada
                            actionButton = `<a href="${letter.SignedFileUrl}" target="_blank" class="text-green-600 hover:text-green-800" title="Muat Turun Selesai"><i class="fas fa-download"></i></a>`;
                        } else {
                            actionButton = `<span class="text-gray-400" title="URL tidak tersedia"><i class="fas fa-link-slash"></i></span>`; // Ikon jika URL tiada
                        }
                    } else { // Pengarah / TP
                        if (letter.Status === 'Draf' && letter.DraftFileID) { // Pastikan ID ada
                            actionButton = `<button class="text-blue-600 hover:text-blue-800" title="Buka & Tandatangan" onclick="openSignModal('${letter.DraftFileID}', '${letter.Tajuk}', '${letter.LetterID}')">
                                <i class="fas fa-file-signature"></i>
                            </button>`;
                        } else {
                            actionButton = `<span class="text-gray-400" title="Selesai"><i class="fas fa-check"></i></span>`;
                        }
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${letter.Timestamp ? new Date(letter.Timestamp).toLocaleDateString('ms-MY') : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${letter.Tajuk || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" ${isStaf ? 'style="display:none;"' : ''}>${letter.Staf || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" ${!isStaf ? 'style="display:none;"' : ''}>${letter.Signatory || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${letter.Status || 'Tidak diketahui'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${actionButton}
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Gagal memuatkan data surat: ${error.message}</td></tr>`;
                 // Toast sudah dipaparkan oleh fetchFromGas
            }
        }

        // 6. Kendalikan penghantaran borang (Hantar Surat)
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdf-file');
            const file = fileInput.files[0];
            const tajuk = document.getElementById('tajuk').value;
            const signatory = document.getElementById('signatoryList').value;

            if (!file || !tajuk || !signatory) {
                showToast('Sila lengkapkan semua medan.', true);
                return;
            }

            loadingText.textContent = 'Memuat naik draf surat...';
            showModal('loadingModal');

            try {
                // Tukar fail ke Base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                   try { // Tambah try...catch dalam onload
                        const pdfBase64 = reader.result.split(',')[1];
                        
                        const payload = {
                            stafName: currentUser.Nama,
                            tajuk: tajuk,
                            signatory: signatory,
                            fileName: file.name,
                            pdfBase64: pdfBase64
                        };

                        await fetchFromGas('uploadDraft', payload, 'POST');
                        
                        closeModal('loadingModal');
                        showToast('Surat berjaya dihantar!', false);
                        document.getElementById('upload-form').reset();
                        showPage('senarai-surat'); // Kembali ke senarai
                   } catch (innerError) {
                       closeModal('loadingModal');
                       // fetchFromGas sudah memaparkan toast ralat
                       console.error("Ralat dalam reader.onload:", innerError);
                   }
                };
                 reader.onerror = (error) => { // Tambah onerror
                    closeModal('loadingModal');
                    showToast('Gagal membaca fail PDF.', true);
                    console.error("Ralat FileReader:", error);
                 };
            } catch (error) {
                closeModal('loadingModal');
                // fetchFromGas sudah memaparkan toast ralat
                 console.error("Ralat luar:", error);
            }
        });

        // 7. Logik Tandatangan (Bahagian Paling Kompleks)
        
        const signCanvas = document.getElementById('signature-canvas');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pdfViewer = document.getElementById('pdf-viewer');
        const signCtx = signCanvas.getContext('2d');
        let drawing = false;

        async function openSignModal(draftFileId, tajuk, letterId) {
            // Reset data
            currentSignPdfData = { draftFileId, tajuk, letterId };
            document.getElementById('signModalTitle').textContent = `Tandatangan: ${tajuk}`;
            // Set warna stroke (cth: hitam) dan ketebalan
            signCtx.strokeStyle = "#000000"; 
            signCtx.lineWidth = 2; 
            signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
            
            loadingText.textContent = 'Memuatkan draf PDF...';
            showModal('loadingModal');
            showModal('signModal'); // Tunjukkan di belakang loading

            try {
                const data = await fetchFromGas('getDraftPdf', { fileId: draftFileId });
                currentSignPdfData.pdfBase64 = data.pdfBase64; // Simpan untuk save

                const pdfData = atob(data.pdfBase64);
                // Guna Uint8Array untuk pdf.js v2+
                const pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(pdfData.split('').map(char => char.charCodeAt(0))) }).promise; 
                
                // Papar mukasurat pertama
                const page = await pdfDoc.getPage(1); // Mula dari 1
                const viewport = page.getViewport({ scale: 1.5 });

                // Set saiz kanvas berdasarkan saiz PDF
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;
                signCanvas.width = viewport.width;
                signCanvas.height = viewport.height;
                // Selaraskan ketinggian viewer
                pdfViewer.style.height = `${Math.min(viewport.height, window.innerHeight * 0.6)}px`; // Hadkan ketinggian modal

                const renderContext = {
                    canvasContext: pdfCanvas.getContext('2d'),
                    viewport: viewport
                };
                await page.render(renderContext).promise;

                closeModal('loadingModal');

            } catch (error) {
                closeModal('loadingModal');
                closeModal('signModal');
                 // fetchFromGas sudah memaparkan toast ralat
                 console.error("Ralat membuka modal tandatangan:", error);
            }
        }

        // Fungsi melukis
        function startDrawing(e) {
            drawing = true;
            signCtx.beginPath();
            // Dapatkan posisi relatif kepada kanvas
            const rect = signCanvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            signCtx.moveTo(x, y);
        }

        function draw(e) {
            if (!drawing) return;
             // Dapatkan posisi relatif kepada kanvas
            const rect = signCanvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            signCtx.lineTo(x, y);
            signCtx.stroke();
        }

        function stopDrawing() {
            if (drawing) {
                signCtx.closePath(); // Tutup path selepas melukis
                drawing = false;
            }
        }

        // Acara Tetikus
        signCanvas.addEventListener('mousedown', startDrawing);
        signCanvas.addEventListener('mousemove', draw);
        signCanvas.addEventListener('mouseup', stopDrawing);
        signCanvas.addEventListener('mouseout', stopDrawing); 

        // Acara Sentuhan (Touch Events)
        signCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Elak skrol
            startDrawing(e.touches[0]); 
        }, { passive: false }); // Perlukan passive: false untuk preventDefault
        signCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Elak skrol
            draw(e.touches[0]);
        }, { passive: false });
        signCanvas.addEventListener('touchend', stopDrawing);
        signCanvas.addEventListener('touchcancel', stopDrawing); // Jika sentuhan dibatalkan

        // Padam tandatangan
        document.getElementById('clear-signature').addEventListener('click', () => {
            signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
        });

        // Batal tandatangan
        document.getElementById('cancel-sign').addEventListener('click', () => {
            closeModal('signModal');
        });

        // Simpan tandatangan
        document.getElementById('save-signature').addEventListener('click', async () => {
             // Semak jika kanvas kosong
            if (isCanvasBlank(signCanvas)) {
                showToast('Sila lukis tandatangan anda dahulu.', true);
                return;
            }
            
            loadingText.textContent = 'Menyimpan tandatangan...';
            showModal('loadingModal');

            try {
                // 1. Dapatkan tandatangan sebagai imej PNG Base64
                // Guna latar belakang lutsinar jika boleh
                const signatureImageBase64 = signCanvas.toDataURL('image/png'); 
                
                // 2. Muatkan PDF asal menggunakan pdf-lib
                const pdfBytes = await fetch(`data:application/pdf;base64,${currentSignPdfData.pdfBase64}`).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(pdfBytes);

                // 3. Masukkan imej tandatangan ke dalam PDF
                const signatureImage = await pdfDoc.embedPng(signatureImageBase64);
                
                const pages = pdfDoc.getPages();
                const firstPage = pages[0]; // Letak di mukasurat pertama

                // Skala saiz imej
                const { width, height } = signatureImage.scale(0.25); // Skala 25% (lebih kecil)
                
                // Letak tandatangan (di sudut bawah-kanan)
                 const padding = 50; 
                firstPage.drawImage(signatureImage, {
                    x: firstPage.getWidth() - width - padding, // Align kanan
                    y: padding,                            // Align bawah
                    width: width,
                    height: height,
                });
                
                // 4. Simpan PDF baru sebagai Base64
                const newPdfBytes = await pdfDoc.save();
                // Cara menukar ArrayBuffer ke Base64 yang lebih selamat
                const newPdfBase64 = btoa(new Uint8Array(newPdfBytes).reduce((data, byte) => data + String.fromCharCode(byte), ''));

                // 5. Hantar ke Google Apps Script
                await fetchFromGas('saveSigned', {
                    draftFileId: currentSignPdfData.draftFileId,
                    fileName: `(TT) ${currentSignPdfData.tajuk}.pdf`, // Nama fail lebih pendek
                    signedPdfBase64: newPdfBase64
                }, 'POST');
                
                closeModal('loadingModal');
                closeModal('signModal');
                showToast('Surat berjaya ditandatangani dan disimpan!', false);
                showPage('senarai-surat'); // Muat semula senarai

            } catch (error) {
                closeModal('loadingModal');
                console.error('Ralat menyimpan tandatangan:', error);
                 // Toast sudah dipaparkan oleh fetchFromGas
                 showToast(`Gagal menyimpan: ${error.message}`, true); // Pastikan ralat dipaparkan
            }
        });

        // Fungsi untuk menyemak jika kanvas kosong
        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            // Jika semua piksel adalah lutsinar (alpha=0), kanvas kosong
            return !pixelBuffer.some(pixel => pixel !== 0); 
        }

        // --- PENGURUSAN SESI (SESSION) ---

        // Log keluar / Tukar Pengguna
        document.getElementById('logout-button').addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('sfdgUser');
            // Muatkan semula halaman untuk reset sepenuhnya
            window.location.reload(); 
        });

        // Pendaftaran Event Listener Navigasi
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                if (currentUser) {
                    showPage(pageId);
                } else {
                    // Sepatutnya tidak berlaku jika modal login berfungsi, tetapi sebagai fallback
                    window.location.reload(); 
                }
            });
        });

        // --- MULA APLIKASI (DOM Content Loaded) ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('sfdgUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser && currentUser.Nama && currentUser.Jawatan) {
                        setupUIPerRole(currentUser.Jawatan);
                        closeModal('roleModal');
                        showPage('senarai-surat'); 
                        loadSignatoriesForForm(); // Muat senarai pelulus
                    } else {
                         // Data pengguna tidak sah, paksa login semula
                        localStorage.removeItem('sfdgUser');
                        showModal('roleModal');
                        loadUsersForLogin();
                        loadSignatoriesForForm();
                    }
                } catch (e) {
                     // Ralat parse JSON, paksa login semula
                    localStorage.removeItem('sfdgUser');
                    showModal('roleModal');
                    loadUsersForLogin();
                    loadSignatoriesForForm();
                }
            } else {
                showModal('roleModal');
                loadUsersForLogin();
                loadSignatoriesForForm();
            }
        });

    </script>
</body>
</html>

