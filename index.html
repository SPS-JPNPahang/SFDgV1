<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital (Firebase)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style> /* ... CSS sama seperti Fasa 17 ... */ </style>
</head>
<body class="bg-light">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"; // Import getIdToken

        const firebaseConfig = { /* ... firebaseConfig anda ... */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        document.addEventListener("DOMContentLoaded", () => {
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec"; // URL BARU ANDA
            let userSession = { token: null, nama: null, peranan: null, email: null, firebaseToken: null };
            const signerState = { /* ... kod sama ... */ };
            const signerModal = new bootstrap.Modal(document.getElementById("signer-modal"));
            const loginContainer = document.getElementById("login-container");
            const appContainer = document.getElementById("app-container");
            const loadingSpinner = document.getElementById("loading-spinner");

            // --- onAuthStateChanged DIUBAHSUAI ---
            onAuthStateChanged(auth, async (user) => {
                showLoading(true);
                if (user) {
                    try {
                        const idToken = await getIdToken(user, true); // Dapatkan/Refresh ID Token
                        userSession.firebaseToken = idToken;
                        userSession.email = user.email;

                        // Panggil API untuk dapatkan Nama & Peranan DENGAN token Firebase
                        const appData = await apiCall("getUserData", { email: user.email }); // Hantar e-mel dalam body juga
                        
                        if (appData.status === "success") {
                            userSession.nama = appData.nama;
                            userSession.peranan = appData.peranan;
                            sessionStorage.setItem("sfdg_session", JSON.stringify(userSession));
                            showApp();
                        } else {
                            throw new Error(appData.message || "Gagal mendapatkan data pengguna dari API.");
                        }
                    } catch (error) {
                        console.error("Auth State/API Error:", error);
                        alert(`Ralat pengesahan atau data pengguna: ${error.message}`);
                        handleLogout(); // Log keluar jika gagal
                    }
                } else {
                    handleLogout();
                }
                showLoading(false);
            });
            
            // --- apiCall DIUBAHSUAI ---
            async function apiCall(action, payload = {}) {
                showLoading(true);
                let idToken = userSession.firebaseToken; // Guna token dari sesi

                // Cuba dapatkan token terkini jika ada pengguna
                const currentUser = auth.currentUser;
                if (currentUser) {
                    try {
                        idToken = await getIdToken(currentUser, true); // Paksa refresh token
                        userSession.firebaseToken = idToken;
                    } catch (tokenError) {
                        console.error("Gagal refresh Firebase token:", tokenError);
                        handleLogout();
                        throw new Error("Gagal mengesahkan sesi pengguna.");
                    }
                } else if (action !== 'getUserData') { // Jika tiada pengguna dan bukan getUserData awal
                    handleLogout();
                    throw new Error("Pengguna tidak disahkan.");
                }

                if (!idToken && action !== 'getUserData') { // Semak lagi jika token masih tiada
                    handleLogout();
                    throw new Error("Token pengesahan tidak ditemui.");
                }

                try {
                    const requestBody = { action: action, ...payload };
                    const headers = { "Content-Type": "application/json" };
                    // Hanya tambah header Authorization jika token wujud
                    if (idToken) {
                        headers["Authorization"] = `Bearer ${idToken}`;
                    }

                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        body: JSON.stringify(requestBody),
                        headers: headers,
                        mode: 'cors', // <-- Tambah mode cors secara eksplisit
                        redirect: "follow"
                    });

                    // Log response status untuk debug
                    console.log(`API Call (${action}) Status: ${response.status}`);

                    if (!response.ok) {
                         let errorText = response.statusText;
                         try { errorText = await response.text(); } catch(e) {}
                         // Log ralat rangkaian
                         console.error(`Network Error Response (${action}): ${response.status} ${errorText}`);
                         throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                    }
                    const responseText = await response.text();
                    if (!responseText) {
                        console.warn(`API Call (${action}) returned empty response.`);
                        showLoading(false);
                        // Kembalikan objek ralat jika kosong, kecuali mungkin untuk saveSignedPDF
                        if (action !== "saveSignedPDF") {
                           throw new Error("Pelayan tidak membalas dengan data.");
                        }
                         // Untuk saveSignedPDF, respons kosong mungkin OK
                        return { status: "success", message: "Operasi berjaya (tiada data dikembalikan)." };
                    }
                    const result = JSON.parse(responseText);
                    if (result.status === "error") throw new Error(result.message);

                    showLoading(false);
                    return result;
                } catch (error) {
                    showLoading(false);
                    console.error(`API Call Exception (${action}):`, error); // Log ralat exception
                    if (action !== 'getUserData') alert(`Ralat API (${action}): ${error.message}`);
                    if (error.message.includes("Sesi tidak sah") || error.message.includes("token")) {
                         handleLogout();
                    }
                    throw error;
                }
            }


             // --- Fungsi login DIUBAHSUAI (Hanya panggil Firebase) ---
            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("login-email").value;
                const password = document.getElementById("password").value;
                const errorEl = document.getElementById("login-error");
                errorEl.classList.add('d-none');

                showLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Jika berjaya, onAuthStateChanged akan mengendalikan selebihnya
                } catch (error) {
                    console.error("Firebase Login Error:", error);
                    let message = "Log masuk gagal.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        message = "E-mel atau kata laluan tidak sah.";
                    } else if (error.code === 'auth/invalid-email') {
                         message = "Format e-mel tidak sah.";
                    } else {
                         message = `Ralat log masuk: ${error.code || error.message}`;
                    }
                    errorEl.textContent = message;
                    errorEl.classList.remove("d-none");
                    showLoading(false);
                }
                 // Tidak perlu finally di sini, onAuthStateChanged uruskan spinner jika berjaya
            });


            // ... (Salin semua kod lain yang tidak berubah dari Fasa 17) ...
            function showLogin() { /* ... kod sama ... */ }
            function showApp() { /* ... kod sama ... */ }
            function setupTabs() { /* ... kod sama ... */ }
            function switchTab(tabId) { /* ... kod sama ... */ }
            function showLoading(show) { /* ... kod sama ... */ }
            function fileToBase64(file) { /* ... kod sama ... */ }
            function handleLogout() { /* ... kod sama ... */ }
            async function loadHantarSuratForm() { /* ... kod sama ... */ }
            document.getElementById("hantar-surat-form").addEventListener("submit", async (e) => { /* ... kod sama ... */ });
            async function loadDataTab() { /* ... kod sama ... */ }
            async function loadSuratUntukDitandatangani() { /* ... kod sama ... */ }
            async function bukaPenandaTangan(suratId, fileId) { /* ... kod sama ... */ }
            async function renderPDFPage(num) { /* ... kod sama ... */ }
            document.getElementById("prev-page").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("next-page").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("clear-signature-button").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("place-signature-button").addEventListener("click", () => { /* ... kod sama ... */ });
            signerState.pdfCanvas.addEventListener("click", async (e) => { /* ... kod sama ... */ });
            document.getElementById("save-signature-button").addEventListener("click", async () => { /* ... kod sama ... */ });
            document.querySelectorAll(".app-tab").forEach(tab => { /* ... kod sama ... */ });
            document.getElementById("logout-button").addEventListener("click", async () => { /* ... kod sama ... */ });


            // Mulakan aplikasi (onAuthStateChanged akan dipanggil)
        });
    </script>
</body>
</html>
