<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SFDg - Sistem Fail Digital</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f8f9fa; }
        .app-tab { border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .app-tab.active { font-weight: bold; color: #0d6efd !important; border-bottom-color: #0d6efd; background-color: #e9f2ff; }
        .app-tab:hover { background-color: #eef; }
        .app-tab-content { display: none; }
        .app-tab-content.active { display: block; }
        #pdf-render-container { overflow: auto; max-height: 60vh; text-align: center; background: #525659; }
        #pdf-canvas { border: 1px solid #ccc; cursor: crosshair; }
        #signature-pad-container { text-align: center; }
        #signature-canvas { background-color: #fff; cursor: crosshair; width: 400px; height: 200px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .list-group-item-action:hover { background-color: #f5f5f5; }
        .status-draf { border-left: 5px solid #ffc107; }
        .status-selesai { border-left: 5px solid #198754; }
    </style>
</head>
<body class="bg-light">

    <div id="login-container" class="container">
        <div class="row min-vh-100 justify-content-center align-items-center">
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4">Log Masuk SFDg</h2>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="login-id" class="form-label">ID Log Masuk</label>
                                <input type="text" class="form-control" id="login-id" required />
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Kata Laluan</label>
                                <input type="password" class="form-control" id="password" required />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Log Masuk</button>
                            <div id="login-error" class="text-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">SFDg</a>
                <div class="d-flex align-items-center">
                     <span class="navbar-text me-3" id="user-greeting"></span>
                     <button class="btn btn-outline-light" id="logout-button"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </nav>
        <nav class="nav nav-pills flex-column flex-sm-row nav-fill mt-3 px-3" id="main-tabs">
            <a class="nav-link text-dark app-tab" href="#" id="tab-hantar" data-tab="hantar-surat-tab"><i class="bi bi-send-plus"></i> Hantar Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-data" data-tab="data-tab"><i class="bi bi-folder-check"></i> Data Surat Dihantar</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-tandatangan" data-tab="tandatangan-surat-tab"><i class="bi bi-pencil-square"></i> Tandatangan Surat</a>
            <a class="nav-link text-dark app-tab" href="#" id="tab-admin" data-tab="admin-tab"><i class="bi bi-gear"></i> Admin</a>
        </nav>
        <main class="container-fluid mt-4">
            <div id="hantar-surat-tab" class="app-tab-content">
                <h3>Hantar Surat Baru</h3>
                <form id="hantar-surat-form" class="card p-4">
                     <div class="mb-3">
                        <label for="surat-tajuk" class="form-label">Tajuk Surat</label>
                        <input type="text" class="form-control" id="surat-tajuk" required />
                    </div>
                    <div class="mb-3">
                        <label for="surat-sektor" class="form-label">Sektor Penghantar</label>
                        <input type="text" class="form-control" id="surat-sektor" required placeholder="Cth: SPS, SPP"/>
                    </div>
                    <div class="mb-3">
                        <label for="surat-pelulus" class="form-label">Untuk Diluluskan Oleh (Penerima)</label>
                        <select class="form-select" id="surat-pelulus" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="surat-fail" class="form-label">Muat Naik Fail PDF</label>
                        <input type="file" class="form-control" id="surat-fail" accept="application/pdf" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Hantar</button>
                </form>
            </div>
            <div id="data-tab" class="app-tab-content">
                <h3>Status Surat Dihantar</h3>
                <div id="data-list" class="list-group"></div>
            </div>
            <div id="tandatangan-surat-tab" class="app-tab-content">
                <h3>Surat Untuk Ditandatangani</h3>
                <div id="tandatangan-list" class="list-group"></div>
            </div>
            <div id="admin-tab" class="app-tab-content">
                <h3>Panel Admin</h3>
                <p>Paparan untuk Admin akan dibina kemudian.</p>
                <div id="admin-list"></div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="signer-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signer-title">Tandatangan Dokumen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="signer-body">
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <button class="btn btn-outline-secondary" id="prev-page"><i class="bi bi-arrow-left"></i></button>
                            <span class="ms-2 me-2">Muka Surat: <span id="page-num"></span> / <span id="page-count"></span></span>
                            <button class="btn btn-outline-secondary" id="next-page"><i class="bi bi-arrow-right"></i></button>
                        </div>
                        <div>
                            <button class="btn btn-success" id="place-signature-button"><i class="bi bi-pencil-fill"></i> Letak Tandatangan</button>
                            <button class="btn btn-info" id="clear-signature-button"><i class="bi bi-arrow-clockwise"></i> Lukis Semula</button>
                        </div>
                    </div>
                    <div id="signature-pad-container" class="mb-2 p-3 border rounded bg-light">
                        <h6 class="text-center">Sila lukis tandatangan anda di kotak bawah:</h6>
                        <canvas id="signature-canvas" class="border"></canvas>
                    </div>
                    <div id="pdf-render-container">
                        <canvas id="pdf-canvas" class="border w-100"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-signature-button">Simpan & Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-spinner" class="loading-overlay d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.7/signature_pad.umd.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // URL API ANDA
            const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzHnG30XyNX-HOC_1iJn5TarLpUgrcX46mhGrJSXiy6xZwuBIQjbzO66bWkFaqGkULHWg/exec"; // Pastikan URL ini betul

            let userSession = { token: null, nama: null, peranan: null, email: null };
            const signerState = {
                pdfDoc: null, currentPageNum: 1, pdfLibDoc: null, originalPdfBytes: null,
                signaturePad: null, signatureImage: null, currentSuratId: null,
                pdfCanvas: document.getElementById("pdf-canvas"),
                sigCanvas: document.getElementById("signature-canvas"), placement: null
            };
            const signerModal = new bootstrap.Modal(document.getElementById("signer-modal"));
            const loginContainer = document.getElementById("login-container");
            const appContainer = document.getElementById("app-container");
            const loadingSpinner = document.getElementById("loading-spinner");

            function checkSession() { /* ... kod sama ... */ }
            function showLogin() { /* ... kod sama ... */ }
            function showApp() { /* ... kod sama ... */ }
            function setupTabs() { /* ... kod sama ... */ }
            function switchTab(tabId) { /* ... kod sama ... */ }
            function showLoading(show) { /* ... kod sama ... */ }
            function fileToBase64(file) { /* ... kod sama ... */ }
            function handleLogout() { /* ... kod sama ... */ }
            async function loadHantarSuratForm() { /* ... kod sama ... */ }
            document.getElementById("hantar-surat-form").addEventListener("submit", async (e) => { /* ... kod sama ... */ });
            async function loadDataTab() { /* ... kod sama ... */ }
            async function loadSuratUntukDitandatangani() { /* ... kod sama ... */ }
            async function bukaPenandaTangan(suratId, fileId) { /* ... kod sama ... */ }
            async function renderPDFPage(num) { /* ... kod sama ... */ }
            document.getElementById("prev-page").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("next-page").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("clear-signature-button").addEventListener("click", () => { /* ... kod sama ... */ });
            document.getElementById("place-signature-button").addEventListener("click", () => { /* ... kod sama ... */ });
            signerState.pdfCanvas.addEventListener("click", async (e) => { /* ... kod sama ... */ });
            document.getElementById("save-signature-button").addEventListener("click", async () => { /* ... kod sama ... */ });
            document.querySelectorAll(".app-tab").forEach(tab => { /* ... kod sama ... */ });
            
             // ==================================================
            // KOD YANG SAMA SEPERTI SEBELUM INI (SALIN SEMUA)
            // ==================================================
            
            // ... (Salin semua fungsi dari checkSession hingga event listener .app-tab) ...
            
             // Mulakan aplikasi
            checkSession();
            
            // --- FUNGSI apiCall YANG DIUBAHSUAI (v3 - Headers Minimal) ---
            async function apiCall(action, payload = {}) {
                showLoading(true);
                try {
                    const requestBody = {
                        action: action, token: userSession.token, ...payload
                    };
                    const response = await fetch(GAS_API_URL, {
                        method: "POST",
                        body: JSON.stringify(requestBody),
                        // =====================================
                        // HANYA header Content-Type
                        // =====================================
                        headers: {
                           "Content-Type": "application/json"
                        },
                        // =====================================
                        redirect: "follow"
                    });
                    if (!response.ok) {
                         // Cuba dapatkan teks ralat jika ada
                         let errorText = response.statusText;
                         try {
                             errorText = await response.text();
                         } catch(e) {}
                         throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                    }
                    // Semak jika response kosong (mungkin berlaku dgn redirect)
                    const responseText = await response.text();
                    if (!responseText) {
                        // Jika kosong selepas redirect, anggap berjaya tapi tiada data (jarang berlaku)
                        console.warn("API call returned empty response, likely after redirect.");
                        showLoading(false);
                        return { status: "success", message: "Operasi mungkin berjaya (tiada data dikembalikan)." };
                    }
                    // Jika ada teks, cuba parse sebagai JSON
                    const result = JSON.parse(responseText);
                    if (result.status === "error") throw new Error(result.message);
                    
                    showLoading(false);
                    return result;
                } catch (error) {
                    showLoading(false);
                    console.error(`API Call Error (${action}):`, error); // Log ralat ke console
                    if(action !== 'login') alert(`Ralat API: ${error.message}`);
                    if(error.message.includes("Sesi tidak sah")) {
                        handleLogout();
                    }
                    throw error;
                }
            }

            // --- FUNGSI login YANG DIUBAHSUAI (v3 - Headers Minimal) ---
            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const idLogMasuk = document.getElementById("login-id").value;
                const password = document.getElementById("password").value;
                const errorEl = document.getElementById("login-error");
                errorEl.classList.add('d-none'); // Sembunyikan ralat lama

                showLoading(true);
                try {
                    const response = await fetch(GAS_API_URL, {
                      method: "POST",
                      body: JSON.stringify({
                        action: "login", idLogMasuk: idLogMasuk, password: password
                      }),
                      // =====================================
                      // HANYA header Content-Type
                      // =====================================
                      headers: {
                         "Content-Type": "application/json"
                      },
                      // =====================================
                      redirect: "follow"
                    });

                    if (!response.ok) {
                         // Cuba dapatkan teks ralat jika ada
                         let errorText = response.statusText;
                         try {
                             errorText = await response.text();
                         } catch(e) {}
                         throw new Error(`Ralat Rangkaian: ${response.status} ${errorText}`);
                    }
                     // Semak jika response kosong
                    const responseText = await response.text();
                    if (!responseText) {
                        throw new Error("Pelayan tidak membalas dengan data yang sah.");
                    }
                    const result = JSON.parse(responseText);

                    if (result.status === "success") {
                        userSession = {
                            token: result.token, nama: result.nama,
                            peranan: result.peranan, email: idLogMasuk
                        };
                        sessionStorage.setItem("sfdg_session", JSON.stringify(userSession));
                        showApp();
                    } else {
                         throw new Error(result.message);
                    }
                } catch (error) {
                    errorEl.textContent = error.message;
                    console.error("Login Error:", error);
                    errorEl.classList.remove("d-none");
                } finally {
                    showLoading(false);
                }
            });


            // ... (Salin semua kod lain dari Fasa 11/12 bermula dari logoutButton hingga akhir) ...
             checkSession(); // Mulakan aplikasi

        });
    </script>
</body>
</html>
